// Generated by CoffeeScript 1.9.1
(function() {
  var VoiceCall, xml;

  xml = require('xml');

  VoiceCall = (function() {
    function VoiceCall(app, req) {
      this.app = app;
      this.id = this.get(req, 'CallSid');
      if (this.id == null) {
        this.id = 0;
      }
      this.from = this.get(req, 'From');
      this.to = this.get(req, 'To');
      this.direction = this.get(req, 'Direction');
      this.time_started = new Date();
      this.caller_id = this.get(req, 'CallerName');
      this.fromCity = this.get(req, 'FromCity');
      this.fromState = this.get(req, 'FromState');
      this.fromZip = this.get(req, 'FromZip');
      this.fromCountry = this.get(req, 'FromCountry');
      this.toCity = this.get(req, 'ToCity');
      this.toState = this.get(req, 'ToState');
      this.toZip = this.get(req, 'ToZip');
      this.toCountry = this.get(req, 'ToCountry');
    }

    VoiceCall.prototype.output = function(res, x) {
      var xres;
      xres = xml(x, {
        declaration: {
          encoding: 'UTF-8'
        }
      });
      res.set('Content-Type', 'text/xml');
      return res.send(xres);
    };

    VoiceCall.prototype.get = function(req, value) {
      var ref, ref1;
      if (((ref = req.body) != null ? ref[value] : void 0) != null) {
        return req.body[value];
      }
      if (((ref1 = req.query) != null ? ref1[value] : void 0) != null) {
        return req.query[value];
      }
    };

    VoiceCall.prototype.update = function(req, res) {
      this.repeat = this.get(req, 'repeat');
      if (this.repeat == null) {
        this.repeat = 0;
      }
      this.recordingURL = this.get(req, 'RecordingUrl');
      this.recordingID = this.get(req, 'RecordingSid');
      this.recordingDuration = this.get(req, 'RecordingDuration');
      this.digits = this.get(req, 'Digits');
      this.status = this.get(req, 'CallStatus');
      this.duration = this.get(req, 'CallDuration');
      this.outerBody = void 0;
      this.body = [];
      this.response = {
        Response: this.body
      };
      return this.res = res;
    };

    VoiceCall.prototype.acceptInput = function(maxDigits, target, required) {
      var gather, next;
      if (required == null) {
        required = true;
      }
      gather = [];
      gather._attr = {
        action: target,
        numDigits: maxDigits,
        timeout: this.app.settings.timeout
      };
      this.body.push({
        Gather: gather
      });
      next = parseInt(this.repeat) + 1;
      if (required) {
        this.body.push({
          Say: this.app.settings.noInputMessage
        });
        this.body.push({
          Redirect: this.position + "?repeat=" + next
        });
      }
      this.outerBody = this.body;
      return this.body = gather;
    };

    VoiceCall.prototype.setTimeout = function(timeout) {
      return this.body._attr.timeout = timeout;
    };

    VoiceCall.prototype.recordSound = function(target) {
      var next;
      this.body.push({
        Record: {
          _attr: {
            action: target,
            timeout: this.app.settings.timeout
          }
        }
      });
      next = parseInt(this.repeat) + 1;
      this.body.push({
        Say: this.app.settings.noInputMessage
      });
      this.body.push({
        Redirect: this.position + "?repeat=" + next
      });
      return this.go();
    };

    VoiceCall.prototype.say = function(prompt, voice) {
      var toSay;
      if (!voice) {
        voice = this.app.settings.voice;
      }
      if (prompt.url) {
        this.body.push({
          Play: prompt.url
        });
      } else {
        toSay = prompt.text ? prompt.text : prompt;
        this.body.push({
          Say: [
            {
              _attr: {
                voice: voice
              }
            }, toSay
          ]
        });
      }
      return this.body.push({
        Pause: ''
      });
    };

    VoiceCall.prototype.play = function(url) {
      return this.body.push({
        Play: url
      });
    };

    VoiceCall.prototype.go = function() {
      return this.output(this.res, this.response);
    };

    VoiceCall.prototype.goTo = function(target) {
      if (this.outerBody) {
        this.body = this.outerBody;
      }
      this.body.push({
        Redirect: target
      });
      return this.go();
    };

    VoiceCall.prototype.goto = function(target) {
      return this.goTo(target);
    };

    VoiceCall.prototype.hangup = function() {
      this.body.push({
        Hangup: ''
      });
      return this.go();
    };

    return VoiceCall;

  })();

  module.exports = VoiceCall;

}).call(this);

//# sourceMappingURL=voice-call.js.map
